version: '3.9'

services:
  frontend:
    build:
      context: .
      dockerfile: app/frontend/Dockerfile
      target: runtime

    ports:
      - "5050:5050"

    environment:
      - PYTHONUNBUFFERED=1
      - BACKEND_API_URL=http://backend:5001
      - AUTH_API_URL=http://auth:5002

    env_file:
      - ./app/frontend/.env

    depends_on:
      backend:
        condition: service_started
      auth:
        condition: service_started

    # Resource limits for cloud deployment
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  backend:
    build:
      context: .
      dockerfile: app/backend/Dockerfile
      target: runtime

    tty: true
    stdin_open: true

    ports:
      - "5001:5001"

    volumes:
      - ./src/mind:/src/mind
      - backend_data:/data

    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/backend:/src
      - AUTH_API_URL=http://auth:5002
      - HF_HOME=/backend/models

    env_file:
      - ./app/backend/.env

    depends_on:
      auth:
        condition: service_started

    # Resource limits for cloud deployment (higher for ML workloads)
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

  auth:
    build:
      context: .
      dockerfile: app/auth/Dockerfile
      target: runtime

    ports:
      - "5002:5002"

    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://auth_user:auth_pass@db:5432/auth_db

    env_file:
      - ./app/auth/.env

    depends_on:
      - db

    # Resource limits for cloud deployment
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  db:
    image: postgres:15-alpine

    restart: always

    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_pass

    volumes:
      - auth_db_data:/var/lib/postgresql/data

    ports:
      - "5444:5432"

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U auth_user -d auth_db" ]
      interval: 5s
      timeout: 5s
      retries: 5

    # Resource limits for cloud deployment
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

volumes:
  auth_db_data:

  backend_data:
