{% extends "base.html" %}
{% block title %}Detection Results{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/"><i class="ph ph-house me-1"></i>Home</a></li>
        <li class="breadcrumb-item"><a href="/detection">Detection</a></li>
        <li class="breadcrumb-item active" aria-current="page">Results</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<h1 class="mt-4">Detection Discrepancies Results</h1>
<p>Check below the Detection Results available for use.</p>

{% if datasets %}

{% set combined_data = zip(datasets, names, shape, stages) %}
{% for group in combined_data | groupby(3) %}
{% if group.grouper == 4 %}
<hr>

<div id="accordion-stage-{{ group.grouper }}" class="mt-4">
    {% for dataset, topicmodel_list in dataset_detection.items() %}
    <div class="dataset-group mb-3 border rounded-2 shadow-sm">

        <div class="dataset-header list-group-item hover-text-primary fw-bold bg-body-tertiary" role="button"
            aria-expanded="false" aria-controls="content-{{ loop.index }}" style="cursor:pointer; border:none;">
            Dataset: {{ dataset }}
            <span class="chev" aria-hidden="true" style="float:right; transition: transform .2s;">▸</span>
        </div>

        <ul id="content-{{ loop.index }}" class="list-group dataset-list"
            style="display:none; background-color:var(--bs-card-bg); margin:0; border-top:1px solid var(--bs-border-color);">
            {% for tm in topicmodel_list %}
            {% for item in group.list %}
            {% set name = item[1] %}
            {% set shape_tuple = item[2] %}
            {% if name.replace('_contradiction', '') == tm and shape_tuple %}
            {% for topics in shape_tuple %}
            <li class="list-group-item dataset-item hover-text-primary dataset-entry d-flex align-items-center justify-content-between"
                style="background-color:var(--bs-tertiary-bg); border:none; border-bottom:1px solid var(--bs-border-color);">
                <a id="a-{{ name }}-{{ topics }}"
                    href="/detection_results?TM={{ name.replace('_contradiction', '') }}&topics={{ topics }}"
                    style="white-space: pre-wrap;"></a>
                <script>document.getElementById('a-{{ name }}-{{ topics }}').innerHTML = '  -> Discrepancy of <strong>"{{ tm }}"</strong> for <strong>{{ topics }} topics.</strong>'</script>
                <button class="btn btn-outline-danger btn-delete-detection d-flex align-items-center gap-1"
                    data-tm="{{ name.replace('_contradiction', '') }}" data-topics="{{ topics }}"
                    title="Delete this detection run"
                    style="padding: 6px 14px; font-size: 0.9rem; white-space: nowrap;">
                    <i class="ph ph-trash" style="font-size: 1.1rem;"></i> Delete
                </button>
            </li>
            {% endfor %}
            {% endif %}
            {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>
<br>
{% endif %}
{% endfor %}

<!-- Delete Detection Run Confirmation Modal -->
<div class="modal fade" id="deleteDetectionModal" tabindex="-1" aria-labelledby="deleteDetectionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteDetectionModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this detection run?</p>
                <p><strong id="deleteDetectionInfo"></strong></p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteDetectionBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.dataset-header').forEach(function (header) {
            header.addEventListener('click', function () {
                var contentId = header.getAttribute('aria-controls');
                var content = document.getElementById(contentId);
                if (!content) return;

                var expanded = header.getAttribute('aria-expanded') === 'true';
                if (expanded) {
                    content.style.display = 'none';
                    header.setAttribute('aria-expanded', 'false');
                    var chev = header.querySelector('.chev');
                    if (chev) chev.style.transform = '';
                } else {
                    content.style.display = 'block';
                    header.setAttribute('aria-expanded', 'true');
                    var chev = header.querySelector('.chev');
                    if (chev) chev.style.transform = 'rotate(90deg)';
                }
            });
        });

        // Detection deletion
        const detectionModal = new bootstrap.Modal(document.getElementById('deleteDetectionModal'));
        let pendingDetection = null;

        document.querySelectorAll('.btn-delete-detection').forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                e.preventDefault();
                pendingDetection = {
                    tm: this.dataset.tm,
                    topics: this.dataset.topics,
                    element: this.closest('.dataset-entry')
                };
                document.getElementById('deleteDetectionInfo').textContent =
                    `"${pendingDetection.tm}" — ${pendingDetection.topics} topics`;
                detectionModal.show();
            });
        });

        document.getElementById('confirmDeleteDetectionBtn').addEventListener('click', function () {
            if (!pendingDetection) return;
            const { tm, topics, element } = pendingDetection;

            fetch(`/delete_detection?TM=${encodeURIComponent(tm)}&topics_slug=${encodeURIComponent(topics)}`, {
                method: 'DELETE'
            })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(({ ok, data }) => {
                    detectionModal.hide();
                    if (ok) {
                        showToast(data.message || 'Detection run deleted.', 'success');
                        if (element) element.remove();
                    } else {
                        showToast(data.error || 'Failed to delete detection run.', 'danger');
                    }
                    pendingDetection = null;
                })
                .catch(() => {
                    detectionModal.hide();
                    showToast('Request failed.', 'danger');
                    pendingDetection = null;
                });
        });
    });
</script>

{% else %}
<p>No Detection Results available.</p>
{% endif %}
{% endblock %}