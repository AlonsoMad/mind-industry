{% extends "base.html" %}
{% block title %}Detection{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/"><i class="ph ph-house me-1"></i>Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Detection</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/detection.css') }}">


{% if status in ['idle', 'initializing'] %}
{% if dataset_detection %}
<h1>MIND Cultural discrepancy detection</h1>
{% elif topic_keys %}


<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
        <h3 class="mb-0 me-2" id="TopicModel-h3" TM-name="{{ topic_keys['topics'][0]['TM_name'] }}">
            Select topics from the Topic Model "{{ topic_keys["topics"][0]["TM_name"] if topic_keys["topics"] else ''
            }}"
        </h3>

        <!-- Botón Info -->
        <button type="button" class="btn btn-sm btn-outline-info" style="border-radius: 20px;" data-bs-toggle="modal"
            data-bs-target="#infoModal" title="Information">
            <i class="ph ph-info"></i>
        </button>
    </div>

    <div class="btn-group" role="group" aria-label="Visual/Text toggle">
        <button type="button" class="btn btn-primary active" id="btn-visual" data-no-warning>Visual</button>
        <button type="button" class="btn btn-outline-primary" id="btn-text" data-no-warning>Text</button>
        {% if docs_data_1 %}
        <button type="button" class="btn btn-outline-primary" id="btn-docs1" data-no-warning>Docs {{ lang_1 }}</button>
        {% endif %}
        {% if docs_data_2 %}
        <button type="button" class="btn btn-outline-primary" id="btn-docs2" data-no-warning>Docs {{ lang_2 }}</button>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel">Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <h6><strong>Visual / Text / Docs</strong></h6>
                <p>
                    These modes control how the topics of the Topic Model are displayed and selected:
                </p>
                <ul>
                    <li>
                        <strong>Visual:</strong> Displays a graphical view where each topic is represented by a circle.
                        Topics can be selected directly from the graph to analyze discrepancies.
                    </li>
                    <li>
                        <strong>Text:</strong> Shows a list of topics along with their keywords for each language.
                        Topics are selected from the list to analyze discrepancies.
                    </li>
                    <li>
                        <strong>Docs:</strong> Displays a list of documents from the Topic Model.
                        Each document includes a graph showing the proportion of topics within that document.
                    </li>
                </ul>

                <hr>

                <h6><strong>Config Pipeline MIND</strong></h6>
                <p>
                    Advanced configuration options to select the type of LLM to be used and the method
                    for analyzing topic discrepancies.
                </p>

                <hr>

                <h6><strong>Analyze Discrepancies</strong></h6>
                <p>
                    Analyzes discrepancies between the selected topics (from Visual or Text mode,
                    depending on the active view) using a defined sample size.
                </p>
                <p class="text-danger">
                    <strong>Important:</strong> Once the analysis starts, it is not possible to leave the page.
                    Leaving the page will cancel the ongoing process.
                </p>

                <hr>

                <h6><strong>Check Status</strong></h6>
                <p>
                    Displays the current status of the discrepancy analysis process in a terminal-like view
                    once the analysis has started.
                </p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>
{% endif %}
{% elif result_mind %}
<div class="row align-items-center mb-3">
    <label class="col-auto"><strong>Records from:</strong></label>
    <div style="margin-left: 0px; margin-bottom: 5px;">
        <select id="rangeSelector" class="form-control">
            {% for start, end in ranges %}
            <option value="{{ start }}">
                {{ start }} - {{ end - 1 }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>
{% endif %}

<div class="jumbotron" id='jumbotron-detection' style="height: 60vh; overflow: hidden; padding: 2rem;">
    {% if status in ['idle', 'initializing'] %}
    {% if dataset_detection %}
    <p class="lead">Start a session by selecting a dataset and a topic model associated:</p>
    <div class="dataset-accordion">
        <!-- Loading overlay -->
        <div id="loadingOverlay" style="
                    position: fixed;
                    top:0; left:0;
                    width:100%; height:100%;
                    background: rgba(255,255,255,0.9);
                    z-index: 9999;
                    display: none;
                    justify-content: center;
                    align-items: center;
                    font-size: 1.5rem;
                    color: #333;
                ">
            <div>
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div style="margin-top:10px;">Loading, please wait...</div>
            </div>
        </div>


        {% for dataset, topicmodel_list in dataset_detection.items() %}
        <div class="dataset-group mb-3 card border-0 shadow-sm">

            <div class="dataset-header list-group-item hover-text-primary fw-bold bg-body-tertiary" role="button"
                aria-expanded="false" aria-controls="content-{{ loop.index }}" style="cursor:pointer; border:none;">
                Dataset: {{ dataset }}
                <span class="chev" aria-hidden="true" style="float:right; transition: transform .2s;">▸</span>
            </div>

            <ul id="content-{{ loop.index }}" class="list-group list-group-flush dataset-list"
                style="display:none; margin:0; border-top:1px solid var(--bs-border-color);">
                {% for tm in topicmodel_list %}
                <li class="list-group-item dataset-item hover-text-primary dataset-entry"
                    style="background-color:var(--bs-tertiary-bg); border:none; border-bottom:1px solid var(--bs-border-color);"
                    dataset-tm='{ "dataset_name": "{{ dataset }}", "topic_model": "{{ tm }}" }'>
                    <a class="dataset-link d-block px-2 py-1">
                        Topic Model: {{ tm }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </div>

    {% elif topic_keys %}

    <!-- Option 1: Visual -->
    <div id="topicVis" style="display: block; width: 100%; height: 100%; overflow: hidden;"></div>

    <!-- Option 3: Docs lang1 -->
    {% if docs_data_1 %}

    <div id="topicDocs1" style="display: none; width: 100%; height: 100%; position: relative;">
        <div id="topicDocsContent1" style="overflow-y: auto; overflow-x: hidden; padding-bottom: 10px;">
        </div>

        <div id="paginationContainer1" class="d-flex justify-content-center align-items-center" style="
                    background: var(--bs-body-bg);
                    padding: 10px 0;
                    border-top: 1px solid var(--bs-border-color);
                    flex-shrink: 0;
                ">
        </div>
    </div>

    {% endif %}

    <!-- Option 4: Docs lang2 -->
    {% if docs_data_2 %}

    <div id="topicDocs2" style="display: none; width: 100%; height: 100%; position: relative;">
        <div id="topicDocsContent2" style="overflow-y: auto; overflow-x: hidden; padding-bottom: 10px;">
        </div>

        <div id="paginationContainer2" class="d-flex justify-content-center align-items-center" style="
                    background: var(--bs-body-bg);
                    padding: 10px 0;
                    border-top: 1px solid var(--bs-border-color);
                    flex-shrink: 0;
                ">
        </div>
    </div>

    {% endif %}

    <!-- Option 2: Keywords only -->
    <div class="topic-accordion" style="display: none; height: 100%; overflow-y: auto; overflow-x: hidden;">

        {% for topic in topic_keys["topics"] %}
        <div class="topic-group mb-3 card border-0 shadow-sm">

            <!-- Header: Checkbox + Topic title -->
            <div class="dataset-header topic-header list-group-item hover-text-primary fw-bold bg-body-tertiary d-flex align-items-center justify-content-between"
                role="button" aria-expanded="false" aria-controls="topic-content-{{ loop.index }}"
                style="cursor: pointer; border: none;">

                <div class="d-flex align-items-center" style="margin-left: 15px;">
                    <input type="checkbox" class="form-check-input topic-checkbox" name="topic_select"
                        value="{{ topic.id }}"
                        style="cursor: pointer; margin-right: 10px; margin-top: 0; transform: scale(1.1); accent-color: var(--bs-primary);">
                    <label class="mb-0">Topic {{ topic.id }} {{ topic.label }}</label>
                </div>

                <div class="d-flex align-items-center">
                    <span class="chev" aria-hidden="true" style="transition: transform .2s;">▸</span>
                </div>

            </div>

            <!-- Topic keywords -->
            <ul id="topic-content-{{ loop.index }}" class="list-group list-group-flush topic-list"
                style="display: none; margin: 0; border-top: 1px solid var(--bs-border-color);">

                {% for lang in ['EN', 'ES', 'DE', 'IT'] %}
                {% if topic['keywords_' + lang] is defined %}
                <li class="list-group-item topic-item"
                    style="background-color: var(--bs-tertiary-bg); border: none; border-bottom: 1px solid var(--bs-border-color);">
                    <strong>{{ lang }}:</strong> {{ topic['keywords_' + lang] | join(' ') }}
                </li>
                {% endif %}
                {% endfor %}

            </ul>

        </div>
        {% endfor %}
    </div>


    {% else %}
    <p class="lead">No datasets found or error loading datasets.</p>
    {% endif %}

    {% elif status == 'completed' %}
    {% if result_mind and result_columns %}
    <!-- Loading overlay -->
    <div id="loadingOverlay" style="
                position: fixed;
                top:0; left:0;
                width:100%; height:100%;
                background: rgba(255,255,255,0.9);
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 1.5rem;
                color: #333;
            ">
        <div>
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div style="margin-top:10px;">Loading, please wait...</div>
        </div>
    </div>





    <!-- Table Result MIND -->
    <table id="resultsTable" class="table table-striped table-hover table-bordered align-middle">
        <thead>
            <tr>
                {% for col in result_columns %}
                {% if col in ['label', 'final_label'] %}
                <th class="th-with-filter" style="position: relative;">
                    {{ col }}
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm filter-icon-btn filter-btn" type="button"
                            id="dropdown{{ loop.index0 }}" data-bs-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false" data-column="{{ col }}">
                            <i class="bi bi-droplet"></i>
                        </button>
                        <div class="dropdown-menu p-2" aria-labelledby="dropdown{{ loop.index0 }}"
                            style="max-height: 200px; overflow-y: auto;">
                            <!-- All -->
                            <label class="dropdown-item">
                                <input type="checkbox" class="filter-checkbox" data-value="ALL" checked> All
                            </label>
                            {% set label_options =
                            ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY'] %}
                            {% for val in label_options %}
                            <label class="dropdown-item">
                                <input type="checkbox" class="filter-checkbox" data-value="{{ val }}" checked> {{ val }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </th>
                {% else %}
                <th>{{ col }}</th>
                {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody id="resultsBody">

        </tbody>
    </table>
    {% else %}
    <div class="alert alert-warning text-center mt-5">
        <strong>No data available.</strong>
    </div>
    {% endif %}
    {% else %}
    <p>No datasets available.</p>
    {% endif %}
</div>

<div class="modal fade" id="docModal" tabindex="-1" role="dialog" aria-labelledby="docModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="docModalLabel">Document Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Loading document content...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Alert End Process Analysis Discrepancy -->
<div id="exitModal" class="exit-modal" style="display: none;" tabindex="-1" role="dialog"
    aria-labelledby="exitModalLabel" aria-hidden="true">
    <div class="exit-modal-dialog" role="document">
        <div class="exit-modal-content p-3">
            <div class="exit-modal-header">
                <h5 class="exit-modal-title" id="exitModalLabel">Warning</h5>
                <button type="button" class="exit-modal-close" aria-label="Close" id="exitModalClose">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="exit-modal-body">
                <p>If you leave this page, discrepancy analysis will stop.</p>
            </div>
            <div class="exit-modal-footer">
                <button type="button" id="exitYes" class="exit-modal-btn exit-modal-btn-danger">Leave page</button>
                <button type="button" id="exitNo" class="exit-modal-btn exit-modal-btn-secondary">Stay here</button>
            </div>
        </div>
    </div>
</div>



{% if result_mind and result_columns %}
<div id="datatable-controls-1" class="d-flex align-items-center mb-2">
    <!-- Filter Columns -->
    <button class="btn btn-light dropdown-toggle" type="button" id="columnFilterBtn" style="margin-right: 15px;"
        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Filter Columns
    </button>
    <div class="dropdown-menu p-3" aria-labelledby="columnFilterBtn" style="max-height: 250px; overflow-y: auto;">
        <div class="form-check">
            <input class="form-check-input column-all" type="checkbox" value="ALL" id="columnAll">
            <label class="form-check-label" for="columnAll">All</label>
        </div>
        {% for col in result_columns %}
        <div class="form-check">
            <input class="form-check-input column-checkbox" type="checkbox" value="{{ col }}"
                id="column_{{ loop.index0 }}" checked>
            <label class="form-check-label" for="column_{{ loop.index0 }}">{{ col }}</label>
        </div>
        {% endfor %}
    </div>
</div>


<!-- Label quick-filter strip -->
<div id="label-filter-bar" class="d-flex flex-wrap align-items-center gap-2 mb-2">
    <span class="text-muted small me-1">Filter by label:</span>
    <button class="btn btn-sm btn-secondary active" id="lf-btn-all" data-lf-value="ALL">All</button>
    <button class="btn btn-sm label-filter-quick" id="lf-btn-contradiction" data-lf-value="CONTRADICTION" style="background:#dc3545;color:#fff;border:none;">CONTRADICTION</button>
    <button class="btn btn-sm label-filter-quick" id="lf-btn-cultural" data-lf-value="CULTURAL_DISCREPANCY" style="background:#ffc107;color:#212529;border:none;">CULTURAL_DISCREPANCY</button>
    <button class="btn btn-sm label-filter-quick" id="lf-btn-noinfo" data-lf-value="NOT_ENOUGH_INFO" style="background:#17a2b8;color:#fff;border:none;">NOT_ENOUGH_INFO</button>
    <button class="btn btn-sm label-filter-quick" id="lf-btn-nodiscrepancy" data-lf-value="NO_DISCREPANCY" style="background:#28a745;color:#fff;border:none;">NO_DISCREPANCY</button>
    <span class="ms-auto text-muted small" id="label-filter-count"></span>
</div>

<div id="datatable-controls-2" class="d-flex justify-content-between align-items-center mb-3">
    <button id="exportXlsxBtn" class="btn btn-success">
        <i class="bi bi-download"></i> Save & Download XLSX
    </button>
</div>








{% elif topic_keys %}
<div
    class="d-flex flex-wrap align-items-center justify-content-between p-3 mb-4 bg-body-tertiary rounded-3 shadow-sm gap-3">

    <!-- Config Pipeline Trigger -->
    <button type="button" class="btn btn-outline-secondary d-flex align-items-center gap-2" data-bs-toggle="modal"
        data-bs-target="#configPipelineModalLabel" data-no-warning>
        <i class="ph ph-gear"></i>
        <span>Configure Pipeline</span>
    </button>

    <!-- Run Pipeline Controls -->
    <div class="d-flex flex-wrap align-items-center gap-2">
        <div class="input-group" style="max-width: 200px;">
            <span class="input-group-text bg-body-secondary border-secondary-subtle">Sample Size</span>
            <input type="number" class="form-control border-secondary-subtle" id="sampleSizeInput" name="n_samples"
                placeholder="5" value="5" min="1" style="max-width: 80px;">
        </div>

        <button class="btn btn-primary d-flex align-items-center gap-2 mode-selectors" id="analyze_contradictions"
            data-bs-toggle="tab" data-no-warning>
            <i class="ph ph-play"></i>
            <span>Analyze Discrepancies</span>
        </button>

        <button class="btn btn-outline-info d-flex align-items-center gap-2" data-bs-toggle="modal"
            data-bs-target="#logModal" data-no-warning>
            <i class="ph ph-terminal-window"></i>
            <span>Check Status</span>
        </button>
    </div>
</div>

<!-- Configuration Div Pipeline MIND -->
<div class="modal fade" id="configPipelineModalLabel" tabindex="-1" role="dialog"
    aria-labelledby="configPipelineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title" id="configPipelineModalLabel">Configuration Pipeline MIND</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Configure the following values to analyze discrepancies:</p>

                <hr>

                <div class="mb-3 d-flex align-items-center">
                    <label for="llmSelect_type" class="me-2" style="width: 200px;">Type of LLM:</label>
                    <select id="llmSelect_type" class="form-control flex-grow-1">
                        <option value="gemini" selected>Gemini (default)</option>
                        <option value="ollama">Ollama</option>
                        <option value="GPT">GPT</option>
                    </select>
                </div>

                <div id="llmSelect_gemini" class="mb-3 d-flex align-items-center">
                    <label for="llmSelect_gemini_input" class="me-2" style="width: 200px;">Gemini Model:</label>
                    <select id="llmSelect_gemini_input" class="form-control flex-grow-1">
                        {% for model in avaible_models.get('gemini', ['gemini-2.5-flash']) %}
                        <option value="{{ model }}" {% if model=='gemini-2.5-flash' %}selected{% endif %}>{{ model }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div id="llmSelect_ollama" class="mb-3 d-flex align-items-center" style="display:none;">
                    <label for="llmSelect_ollama_input" class="me-2" style="width: 200px;">Ollama LLM:</label>
                    <select id="llmSelect_ollama_input" class="form-control flex-grow-1">

                    </select>
                </div>

                <div id="server_ollama" class="mb-3 d-flex align-items-center" style="display:none;">
                    <label for="server_ollama_input" class="me-2" style="width: 200px;">Ollama Server:</label>
                    <select id="server_ollama_input" class="form-control flex-grow-1">
                        {% for server in avaible_models.keys() %}
                        {% if server != "gemini" %}
                        <option value="{{ server }}">{{ server }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>


                <div id="llmSelect_gpt" class="mb-3 d-flex align-items-center" style="display: none;">
                    <label for="llmSelect_gpt_input" class="me-2" style="width: 200px;">GPT LLM:</label>
                    <select id="llmSelect_gpt_input" class="form-control flex-grow-1">
                        <option value="gpt-4-turbo">gpt-4-turbo</option>
                        <option value="gpt-4" selected>gpt-4</option>
                        <option value="gpt-4o-mini">gpt-4o-mini</option>
                        <option value="gpt-4o">gpt-4o</option>
                    </select>
                </div>

                <div id="gptApiKey" class="mb-3 d-flex align-items-center" style="display: none;">
                    <label for="llmSelect_gpt" class="me-2" style="width: 200px;">GPT API Key:</label>
                    <input id="gptApiKeyInput" class="form-control flex-grow-1" value="" type="password"
                        autocomplete="new-password" placeholder="sk-*******-*******-******"></input>
                </div>

                <hr>

                <div class="d-flex align-items-center mb-2">
                    <label for="methodSelect" class="me-2" style="width: 200px; margin-bottom: 0;">
                        Method:
                    </label>
                    <select id="methodSelect" class="form-control flex-grow-1">
                        <option value="ENN">ENN</option>
                        <option value="ANN">ANN</option>
                        <option value="TB-ENN" selected>TB-ENN</option>
                        <option value="TB-ANN">TB-ANN</option>
                    </select>
                </div>

                <div class="d-flex align-items-center">
                    <label for="enableWeight" class="me-2" style="width: 200px; margin-bottom: 0;">
                        Do Weighting:
                    </label>
                    <div class="form-control d-flex align-items-center flex-grow-1"
                        style="height: auto; border: none; padding-left: 0;">
                        <input type="checkbox" id="enableWeight" checked
                            style="width: 18px; height: 18px; cursor: pointer;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Status Pipeline MIND -->
<div class="modal fade" id="logModal" tabindex="-1" role="dialog" aria-labelledby="logModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logModalLabel">Pipeline Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="logTerminal"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endif %}








<!-- Data Bridge: server-side data for detection.js -->
<script>
    window.__DETECTION_DATA = {
    {% if docs_data_1 %} docsData1: {{ docs_data_1 | tojson | safe }}, {% endif %}
    {% if docs_data_2 %} docsData2: {{ docs_data_2 | tojson | safe }}, {% endif %}
    {% if topic_keys %} topicKeys: {{ topic_keys | tojson }}, {% endif %}
    {% if columns_json %} columnsJson: {{ columns_json | safe }}, {% endif %}
    {% if result_columns %} resultColumns: {{ result_columns | tojson | safe }}, {% endif %}
    {% if non_orderable_indices %} nonOrderableIndices: {{ non_orderable_indices | safe }}, {% endif %}
    {% if avaible_models %} availableModels: {{ avaible_models | tojson }}, {% endif %}
    {% if csrf_token %} csrfToken: "{{ csrf_token }}", {% endif %}
  };
</script>

<!-- External CDN dependencies -->
{% if docs_data_1 or docs_data_2 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endif %}
{% if topic_keys %}
<script src="https://d3js.org/d3.v7.min.js"></script>
{% endif %}
{% if result_mind and result_columns %}
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
{% endif %}

<!-- Detection Page JS -->
<script src="{{ url_for('static', filename='js/detection.js') }}"></script>


{% endblock %}