{% extends "base.html" %}
{% block title %}Profile{% endblock %}

{% block content %}
<h1 class="mt-5" style="margin-top: -5px;"> {{ username }}'s profile</h1>
<hr>

<h2 class="mt-3">Upload Datasets</h2>
<p class="text-muted">Upload your dataset files (.csv, .parquet, .zip, .tar, .7z, .md, .yaml, .xml, .txt)</p>

<form id="upload-form" enctype="multipart/form-data">
    <div class="border rounded p-4 text-center bg-body-secondary" id="drop-zone">
        <p class="mb-2">Drag & drop your file here, or click to select</p>
        <input type="file" name="dataset_file" id="file-input" class="d-none"
            accept=".csv,.parquet,.zip,.tar,.tar.gz,.tar.bz2,.tar.xz,.7z,.md,.yaml,.yml,.xml,.txt" required>
        <button type="button" class="btn btn-outline-primary btn-sm" id="browse-btn">Choose File</button>
        <div id="error-message" class="text-danger" style="display: none; margin-top: 5px;">
            File is too large. Maximum size allowed is 10MB.
        </div>
        <p class="mt-2 text-muted" id="file-name"></p>
    </div>

    <div class="d-flex align-items-center justify-content-between mt-3">
        <div class="d-flex align-items-center" style="gap: 10px;">
            <label for="action-select" class="mb-0">Choose a Stage:</label>
            <select id="action-select" name="action" class="form-select" required style="width: auto;">
                <option value="" disabled selected>Select an option</option>
                <option value="1_RawData">Raw Data</option>
                <option value="2_PreprocessData">Preprocessed Data</option>
            </select>
        </div>
    </div>

    <div id="sep-csv" style="display: none;" class="mb-0">
        <hr>
        <label for="sep-select">Indicate a separator for csv:</label>
        <select id="sep-select" name="sep-csv" class="form-select">
            <option value="" disabled selected>Select an option</option>
            <option value=",">,</option>
            <option value=";">;</option>
        </select>
    </div>

    <div id="textColumn" style="display: none;" class="mb-0">
        <hr>
        <label for="textColInput">Text Column:</label>
        <input class="form-control" id="textColInput" placeholder="Text Column" value="">
    </div>

    <hr>
    <button type="submit" class="btn btn-success form-control" id="btn-success-files">Upload Dataset</button>
</form>

<hr>

<!-- Custom Categories Management -->
<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mt-3 mb-0">Custom Detection Categories</h2>
    <span class="badge bg-secondary fs-6" id="catUsageBadge">{{ categories_count }} / {{ categories_max }}</span>
</div>
<p class="text-muted">Define custom detection categories with prompt instructions and few-shot examples. These
    categories will be available for selection when configuring the MIND pipeline.</p>

<div id="categoriesList">
    {% if categories %}
    {% for cat in categories %}
    <div class="card mb-2 category-card" data-cat-id="{{ cat.id }}">
        <div class="card-body d-flex justify-content-between align-items-start py-2">
            <div style="flex:1; min-width:0;">
                <strong>{{ cat.name }}</strong>
                <p class="text-muted small mb-0 text-truncate" title="{{ cat.prompt_instruction }}">{{
                    cat.prompt_instruction }}</p>
            </div>
            <div class="d-flex gap-2 ms-3 flex-shrink-0">
                <button class="btn btn-outline-primary btn-edit-cat px-3" data-cat-id="{{ cat.id }}"
                    data-cat-name="{{ cat.name }}" data-cat-prompt="{{ cat.prompt_instruction | forceescape }}"
                    data-cat-examples='{{ cat.examples | forceescape if cat.examples else "" }}'>
                    <i class="ph ph-pencil-simple me-1"></i>Edit</button>
                <button class="btn btn-outline-danger btn-delete-cat px-3" data-cat-id="{{ cat.id }}">
                    <i class="ph ph-trash me-1"></i>Delete</button>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-muted" id="noCategoriesMsg">No custom categories yet.</p>
    {% endif %}
</div>

<button class="btn btn-primary mt-2 mb-3" id="btnCreateCategory">
    <i class="ph ph-plus me-1"></i>Create Category
</button>

<!-- Create/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="categoryModalLabel">Create Category</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="catEditId" value="">
                <div class="mb-4">
                    <label for="catName" class="form-label fs-6 fw-semibold">Name <small
                            class="text-muted fw-normal">(SCREAMING_SNAKE_CASE)</small></label>
                    <input type="text" class="form-control form-control-lg" id="catName" placeholder="MY_CATEGORY"
                        maxlength="40" style="text-transform: uppercase; font-size: 1.1rem;">
                    <div class="form-text">Letters, digits, and underscores only. Max 40 characters.</div>
                </div>
                <div class="mb-4">
                    <label for="catPrompt" class="form-label fs-6 fw-semibold">Prompt Instruction</label>
                    <textarea class="form-control" id="catPrompt" rows="5" maxlength="2000" style="font-size: 1rem;"
                        placeholder="Describe when this category should be selected..."></textarea>
                </div>
                <div class="mb-4">
                    <label for="catExamples" class="form-label fs-6 fw-semibold">Examples <small
                            class="text-muted fw-normal">(optional JSON array)</small></label>
                    <textarea class="form-control" id="catExamples" rows="6"
                        style="font-size: 0.9rem; font-family: monospace;"
                        placeholder='[{"question":"...","answer_1":"...","answer_2":"...","reason":"...","expected_label":"MY_CATEGORY"}]'></textarea>
                </div>
                <div id="catModalError" class="text-danger small" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveCategory">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const catModal = new bootstrap.Modal(document.getElementById('categoryModal'));
        const catModalLabel = document.getElementById('categoryModalLabel');
        const catEditId = document.getElementById('catEditId');
        const catName = document.getElementById('catName');
        const catPrompt = document.getElementById('catPrompt');
        const catExamples = document.getElementById('catExamples');
        const catModalError = document.getElementById('catModalError');
        const btnSave = document.getElementById('btnSaveCategory');
        const catUsage = document.getElementById('catUsageBadge');
        const nameRegex = /^[A-Z][A-Z0-9_]*$/;

        function showCatError(msg) {
            catModalError.textContent = msg;
            catModalError.style.display = 'block';
        }
        function hideCatError() { catModalError.style.display = 'none'; }

        function updateUsage(delta) {
            const parts = catUsage.textContent.split('/');
            const current = parseInt(parts[0].trim()) + delta;
            catUsage.textContent = current + ' / ' + parts[1].trim();
        }

        // Open Create modal
        document.getElementById('btnCreateCategory').addEventListener('click', () => {
            catModalLabel.textContent = 'Create Category';
            catEditId.value = '';
            catName.value = '';
            catPrompt.value = '';
            catExamples.value = '';
            catName.disabled = false;
            hideCatError();
            catModal.show();
        });

        // Open Edit modal
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-edit-cat');
            if (!btn) return;
            catModalLabel.textContent = 'Edit Category';
            catEditId.value = btn.dataset.catId;
            catName.value = btn.dataset.catName;
            catPrompt.value = btn.dataset.catPrompt;
            catExamples.value = btn.dataset.catExamples || '';
            catName.disabled = false;
            hideCatError();
            catModal.show();
        });

        // Save (create or update)
        btnSave.addEventListener('click', function () {
            hideCatError();
            const name = catName.value.trim().toUpperCase();
            const prompt = catPrompt.value.trim();
            const examples = catExamples.value.trim();

            if (!name) return showCatError('Name is required.');
            if (!nameRegex.test(name)) return showCatError('Name must be SCREAMING_SNAKE_CASE (e.g. MY_CATEGORY).');
            if (!prompt) return showCatError('Prompt instruction is required.');

            if (examples) {
                try { JSON.parse(examples); } catch (e) { return showCatError('Examples must be valid JSON.'); }
            }

            const payload = { name, prompt_instruction: prompt, examples: examples || null };
            const editId = catEditId.value;
            const url = editId ? '/categories/' + editId : '/categories';
            const method = editId ? 'PUT' : 'POST';

            btnSave.disabled = true;
            btnSave.textContent = 'Saving...';

            fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                .then(r => r.json().then(d => ({ ok: r.ok, status: r.status, data: d })))
                .then(({ ok, status, data }) => {
                    if (!ok) { showCatError(data.error || 'Failed to save.'); return; }
                    catModal.hide();
                    if (editId) {
                        // Update card in-place
                        const card = document.querySelector(`.category-card[data-cat-id="${editId}"]`);
                        if (card) {
                            card.querySelector('strong').textContent = data.category.name;
                            card.querySelector('.text-truncate').textContent = data.category.prompt_instruction;
                            card.querySelector('.text-truncate').title = data.category.prompt_instruction;
                            const editBtn = card.querySelector('.btn-edit-cat');
                            editBtn.dataset.catName = data.category.name;
                            editBtn.dataset.catPrompt = data.category.prompt_instruction;
                            editBtn.dataset.catExamples = data.category.examples || '';
                        }
                        showToast('Category updated.', 'success');
                    } else {
                        // Append new card
                        const noMsg = document.getElementById('noCategoriesMsg');
                        if (noMsg) noMsg.remove();
                        const c = data.category;
                        const html = `<div class="card mb-2 category-card" data-cat-id="${c.id}">
                        <div class="card-body d-flex justify-content-between align-items-start py-2">
                            <div style="flex:1;min-width:0;">
                                <strong>${c.name}</strong>
                                <p class="text-muted small mb-0 text-truncate" title="${c.prompt_instruction}">${c.prompt_instruction}</p>
                            </div>
                        <div class="d-flex gap-2 ms-3 flex-shrink-0">
                                <button class="btn btn-outline-primary btn-edit-cat px-3"
                                    data-cat-id="${c.id}" data-cat-name="${c.name}"
                                    data-cat-prompt="${c.prompt_instruction}"
                                    data-cat-examples='${c.examples || ""}'>
                                    <i class='ph ph-pencil-simple me-1'></i>Edit</button>
                                <button class="btn btn-outline-danger btn-delete-cat px-3" data-cat-id="${c.id}">
                                    <i class='ph ph-trash me-1'></i>Delete</button>
                            </div>
                        </div>
                    </div>`;
                        document.getElementById('categoriesList').insertAdjacentHTML('beforeend', html);
                        updateUsage(1);
                        showToast('Category created.', 'success');
                    }
                })
                .catch(() => showCatError('Request failed.'))
                .finally(() => { btnSave.disabled = false; btnSave.textContent = 'Save'; });
        });

        // Delete
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-delete-cat');
            if (!btn) return;
            if (!confirm('Delete this category?')) return;
            const catId = btn.dataset.catId;
            fetch('/categories/' + catId, { method: 'DELETE' })
                .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
                .then(({ ok, data }) => {
                    if (ok) {
                        btn.closest('.category-card').remove();
                        updateUsage(-1);
                        showToast('Category deleted.', 'success');
                    } else {
                        showToast(data.error || 'Failed to delete.', 'danger');
                    }
                })
                .catch(() => showToast('Request failed.', 'danger'));
        });
    });
</script>

<hr>

<h2 class="mt-3" style="margin-bottom: 20px;">Update {{ username }}'s information</h2>
<form method="POST" action="/profile" id="profileForm" novalidate>
    <div class="mb-3">
        <label for="username" class="form-label">Username</label>
        <input type="text" class="form-control" id="username" name="username" placeholder="{{ username }}">
    </div>
    <div class="mb-3">
        <label for="email" class="form-label">Email address</label>
        <input type="email" class="form-control" id="email" name="email" placeholder="{{ user_id }}">
        <div class="invalid-feedback">Please enter a valid email address.</div>
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" name="password">
    </div>
    <div class="mb-3">
        <label for="password_rep" class="form-label">Confirm password</label>
        <input type="password" class="form-control" id="password_rep" name="password_rep">
        <div class="invalid-feedback">Passwords do not match.</div>
    </div>
    <button type="submit" class="btn btn-primary">Update Profile</button>
</form>

<script>
    const profileForm = document.getElementById('profileForm');
    const profilePassword = document.getElementById('password');
    const profilePasswordRep = document.getElementById('password_rep');

    function checkProfilePasswordMatch() {
        // Only validate if both password fields have values
        if (profilePassword.value || profilePasswordRep.value) {
            if (profilePassword.value !== profilePasswordRep.value) {
                profilePasswordRep.setCustomValidity('Passwords do not match');
            } else {
                profilePasswordRep.setCustomValidity('');
            }
        } else {
            profilePasswordRep.setCustomValidity('');
        }
    }

    profilePassword.addEventListener('input', checkProfilePasswordMatch);
    profilePasswordRep.addEventListener('input', checkProfilePasswordMatch);

    profileForm.addEventListener('submit', function (e) {
        checkProfilePasswordMatch();
        if (!this.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        this.classList.add('was-validated');
    });
</script>

<script>
    const fileInput = document.getElementById('file-input');
    const errorMessage = document.getElementById('error-message');
    const MAX_SIZE_BYTES = 10 * 1024 * 1024;

    fileInput.addEventListener('change', function () {
        if (this.files && this.files[0]) {
            const fileSize = this.files[0].size;

            if (fileSize > MAX_SIZE_BYTES) {
                errorMessage.style.display = 'block';
                this.value = '';
            } else {
                errorMessage.style.display = 'none';
            }
        }
    });
</script>

<script>
    const select = document.getElementById('action-select');
    const textColumn = document.getElementById('textColumn');

    function toggleTextColumn() {
        if (select.value === '2_PreprocessData') {
            textColumn.style.display = 'block';
        } else {
            textColumn.style.display = 'none';
        }
    }
    toggleTextColumn();

    select.addEventListener('change', toggleTextColumn);

    document.addEventListener('DOMContentLoaded', function () {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const fileNameDisplay = document.getElementById('file-name');
        const uploadForm = document.getElementById('upload-form');
        const actionSelect = document.getElementById('action-select');

        const sepCsvDiv = document.getElementById('sep-csv');
        const separatorSelect = document.getElementById('sep-select');
        const csvSeparatorSelect = document.querySelector('#sep-csv select[name="sep-csv"]');

        function csvSeparatorDisplay(file) {
            if (file && file.name.toLowerCase().endsWith('.csv')) {
                sepCsvDiv.style.display = 'block';
            } else {
                sepCsvDiv.style.display = 'none';
            }
        }

        browseBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            fileNameDisplay.textContent = file?.name || '';
            csvSeparatorDisplay(file);
        });

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-primary');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary');
            const file = e.dataTransfer.files[0];

            if (file) {
                fileInput.files = e.dataTransfer.files;
                fileNameDisplay.textContent = file.name;
                csvSeparatorDisplay(file);
            }
        });

        // Reset upload form to initial state
        function resetUploadForm() {
            fileInput.value = '';
            fileNameDisplay.textContent = '';
            sepCsvDiv.style.display = 'none';
        }

        uploadForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const file = fileInput.files[0];
            if (!file) return showToast("Please select a file first.");

            let stage = actionSelect.value;
            if (!stage) return showToast("Please select a stage.");

            const buttonSubmit = document.getElementById('btn-success-files')
            buttonSubmit.disabled = true;
            buttonSubmit.textContent = 'Uploading...';

            stage = stage.replace(/\s+/g, "_");

            const formData = new FormData();
            formData.append('file', file);
            formData.append('stage', stage);

            const esCsv = file.name.toLowerCase().endsWith('.csv');
            if (esCsv) {
                const separator = csvSeparatorSelect.value;
                if (!separator) {
                    showToast("Please select a separator for the CSV file.");
                    buttonSubmit.disabled = false;
                    buttonSubmit.textContent = 'Upload Dataset';
                    return;
                }
                formData.append('sep', separator);
            }

            const textCol = document.getElementById('textColInput').value.trim()
            if (document.getElementById('textColumn').style.display != 'none') {
                if (textCol === '') {
                    showToast("Please indicate the text column for the raw data.");
                    buttonSubmit.disabled = false;
                    buttonSubmit.textContent = 'Upload Dataset';
                    return;
                }
                formData.append('textColumn', textCol);
            }

            fetch('/upload_dataset', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    showToast(data.message || data.error, data.error ? 'danger' : 'success');
                    buttonSubmit.disabled = false;
                    buttonSubmit.textContent = 'Upload Dataset';
                    resetUploadForm();
                })
                .catch(err => {
                    console.error(err);
                    showToast("Upload failed. Please try again.", "danger");
                    buttonSubmit.disabled = false;
                    buttonSubmit.textContent = 'Upload Dataset';
                    resetUploadForm();
                });
        });
    });
</script>

<hr class="mt-5">

<!-- Danger Zone -->
<div class="card border-danger mt-4 mb-5">
    <div class="card-header bg-danger bg-opacity-10 text-danger">
        <h5 class="mb-0"><i class="ph ph-warning me-2"></i>Danger Zone</h5>
    </div>
    <div class="card-body">
        <p>Permanently delete <strong>all</strong> your data from the platform â€” including raw datasets, preprocessed
            data, topic models, detection results, and pipeline logs.</p>
        <p class="text-danger mb-3"><small><strong>This action is irreversible.</strong> All files under your account
                will be permanently removed.</small></p>
        <button type="button" class="btn btn-outline-danger d-flex align-items-center gap-2" id="btn-erase-all"
            style="padding: 10px 22px; font-size: 1rem;">
            <i class="ph ph-trash" style="font-size: 1.2rem;"></i> Delete All My Data
        </button>
    </div>
</div>

<!-- Full Erasure Confirmation Modal -->
<div class="modal fade" id="eraseModal" tabindex="-1" aria-labelledby="eraseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger bg-opacity-10">
                <h5 class="modal-title text-danger" id="eraseModalLabel">
                    <i class="ph ph-warning me-2"></i>Confirm Full Data Erasure
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to <strong>permanently delete all your data</strong>. This includes:</p>
                <ul>
                    <li>Raw and preprocessed datasets</li>
                    <li>Topic model outputs</li>
                    <li>Detection results and checkpoints</li>
                    <li>Pipeline logs and API keys</li>
                </ul>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                <hr>
                <label for="eraseConfirmInput" class="form-label">Type <code>DELETE</code> to confirm:</label>
                <input type="text" class="form-control" id="eraseConfirmInput" placeholder="DELETE" autocomplete="off">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmEraseBtn" disabled>Permanently Delete All
                    Data</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const eraseModal = new bootstrap.Modal(document.getElementById('eraseModal'));
        const eraseInput = document.getElementById('eraseConfirmInput');
        const confirmEraseBtn = document.getElementById('confirmEraseBtn');

        // Open modal
        document.getElementById('btn-erase-all').addEventListener('click', function () {
            eraseInput.value = '';
            confirmEraseBtn.disabled = true;
            eraseModal.show();
        });

        // Enable confirm button only when input === 'DELETE'
        eraseInput.addEventListener('input', function () {
            confirmEraseBtn.disabled = this.value.trim() !== 'DELETE';
        });

        // Execute erasure
        confirmEraseBtn.addEventListener('click', function () {
            confirmEraseBtn.disabled = true;
            confirmEraseBtn.textContent = 'Deleting...';

            fetch('/erase_data', { method: 'DELETE' })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(({ ok, data }) => {
                    eraseModal.hide();
                    if (ok) {
                        showToast('All data has been permanently deleted.', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showToast(data.error || 'Failed to erase data.', 'danger');
                        confirmEraseBtn.disabled = false;
                        confirmEraseBtn.textContent = 'Permanently Delete All Data';
                    }
                })
                .catch(() => {
                    eraseModal.hide();
                    showToast('Request failed.', 'danger');
                    confirmEraseBtn.disabled = false;
                    confirmEraseBtn.textContent = 'Permanently Delete All Data';
                });
        });
    });
</script>

{% endblock %}