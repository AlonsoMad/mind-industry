{% extends "base.html" %}
{% block title %}Preprocessing{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/"><i class="ph ph-house me-1"></i>Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Preprocessing</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/preprocessing.css') }}">

<div class="container mt-5 text-center">
    <h1 class="mb-5">Preprocess your datasets!</h1>

    <div class="d-flex justify-content-center align-items-center flex-wrap">
        <!-- Step 1 -->
        <div class="step-box" data-bs-toggle="modal" data-bs-target="#stepModal" data-step="1">
            Preprocessing<br><small>Click to tune</small>
        </div>

        <div class="arrow">&#8594;</div>

        <!-- Step 2 -->
        <div class="step-box" data-bs-toggle="modal" data-bs-target="#stepModal" data-step="2">
            Topic Modeling<br><small>Click to tune</small>
        </div>

        <div class="arrow">&#8594;</div>

        <!-- Step 3 -->
        <div class="step-box" data-bs-toggle="modal" data-bs-target="#stepModal" data-step="3">
            Data<br><small>Download</small>
        </div>
    </div>
</div>

<div class="modal fade" id="stepModal" tabindex="-1" role="dialog" aria-labelledby="stepModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="min-width: 550px;">
            <div class="modal-header">
                <h5 class="modal-title" id="stepModalLabel">Step Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Step 1: Preprocess Dataset -->
            <div class="modal-body" id="modal-body-1" style="overflow: hidden; position: relative;">

                <!-- Slide 1: Dataset and Output -->
                <div class="step-slide active-slide" id="slide-1">

                    <div class="details-toggle" data-target="#detailsSlide1">
                        <span>Details</span>
                        <i class="arrow"></i>
                    </div>

                    <div class="collapse mt-2" id="detailsSlide1">
                        <div class="card card-body">
                            Select which dataset to preprocess and the output name for the preprocess dataset.
                        </div>
                    </div>

                    <hr>

                    <label for="optionsDatasets1" class="form-label">Select a dataset:</label>
                    <select id="optionsDatasets1" class="form-select">
                        {% if datasets %}
                        <option value="" disabled selected>-- Choose an available dataset --</option>
                        {% for ds, name, stage in zip(datasets, names, stages) %}
                        {% if stage == 1 or stage == '1' %}
                        <option value="{{ name }}">{{ name }}</option>
                        {% endif %}
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No datasets available.</option>
                        {% endif %}
                    </select>

                    <div class="mb-3 mt-3">
                        <label for="TextColumnOutput-Segmentor">Output Dataset Name:</label>
                        <input type="text" id="TextColumnOutput-Segmentor" class="form-control"
                            placeholder="Enter the name for the new dataset">
                    </div>
                </div>

                <!-- Slide 2: Segmentor -->
                <div class="step-slide" id="slide-2">
                    <h5>Segmentor</h5>

                    <hr>

                    <div class="details-toggle" data-target="#detailsSlide2">
                        <span>Details</span>
                        <i class="arrow"></i>
                    </div>

                    <div class="collapse mt-2" id="detailsSlide2">
                        <div class="card card-body details-text" id="detailsSlide2-text">
                            text
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3 mt-3">
                        <label for="TextColumn-Segmentor">Text Column:</label>
                        <input type="text" id="TextColumn-Segmentor" class="form-control"
                            placeholder="Enter text column name">
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="IdColumn-Segmentor">ID Column:</label>
                        <input type="text" id="IdColumn-Segmentor" class="form-control"
                            placeholder="Enter id column name">
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="MinimumLength-Segmentor">Minimum Length:</label>
                        <input type="number" id="MinimumLength-Segmentor" class="form-control" placeholder="100" min="1"
                            value="100">
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="Separator-Segmentor">Separator:</label>
                        <input type="text" id="Separator-Segmentor" class="form-control" placeholder="\n" value="\n">
                    </div>
                </div>

                <!-- Slide 3: Translator -->
                <div class="step-slide" id="slide-3">
                    <h5>Translator</h5>

                    <hr>

                    <div class="details-toggle" data-target="#detailsSlide3">
                        <span>Details</span>
                        <i class="arrow"></i>
                    </div>

                    <div class="collapse mt-2" id="detailsSlide3">
                        <div class="card card-body details-text" id="detailsSlide3-text">
                            text
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3 mt-3">
                        <label for="SourceLanguage" class="form-label">Source Language:</label>
                        <select id="SourceLanguage" class="form-select">
                            <option value="" disabled selected>-- Select source language --</option>
                            <option value="en">English (en)</option>
                            <option value="es">Spanish (es)</option>
                            <option value="de">German (de)</option>
                            <option value="it">Italian (it)</option>
                        </select>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="TargetLanguage" class="form-label">Target Language:</label>
                        <select id="TargetLanguage" class="form-select">
                            <option value="" disabled selected>-- Select target language --</option>
                            <option value="mono">N/A (Monolingual dataset)</option>
                            <option value="en">English (en)</option>
                            <option value="es">Spanish (es)</option>
                            <option value="de">German (de)</option>
                            <option value="it">Italian (it)</option>
                        </select>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="LanguageColumnTranslator">Language Column:</label>
                        <input type="text" id="LanguageColumnTranslator" class="form-control"
                            placeholder="Enter language column name">
                    </div>
                </div>

                <!-- Slide 4: Data Preparer -->
                <div class="step-slide" id="slide-4">
                    <h5>Data Preparer</h5>

                    <div class="details-toggle" data-target="#detailsSlide4">
                        <span>Details</span>
                        <i class="arrow"></i>
                    </div>

                    <div class="collapse mt-2" id="detailsSlide4">
                        <div class="card card-body">
                            The Data Preparer Component allows to build a polylingual dataset.
                        </div>
                    </div>

                    <hr>

                    <p>All configuration is ready. Click "Accept Dataset to Preprocess" to continue.</p>
                </div>

            </div>

            <!-- Step 2: Topic Modeling -->
            <div class="modal-body" id="modal-body-2">

                <div class="details-toggle" data-target="#details2-TopicModeling">
                    <span>Details</span>
                    <i class="arrow"></i>
                </div>

                <div class="collapse mt-2" id="details2-TopicModeling">
                    <div class="card card-body details-text" id="details2-TopicModeling-text">
                        text
                    </div>
                </div>

                <hr>

                <label for="optionsDatasets2" class="form-label">Select an option: </label>
                <select id="optionsDatasets2" class="form-select">
                    {% if datasets %}
                    <option value="" disabled selected>-- Choose an avaible dataset --</option>
                    {% for ds, name, stage in zip(datasets, names, stages) %}
                    {% if stage == 2 or stage == '2' %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <option value="" disabled>No datasets available.</option>
                    {% endif %}
                </select>

                <div class="mb-3 mt-3">
                    <label for="outputPath">Output Path:</label>
                    <input type="text" id="outputPath2" class="form-control"
                        placeholder="Enter name of the topic modeling">
                </div>

                <hr>

                <div class="mb-3 mt-3">
                    <label for="lang1" class="form-label">Lang 1:</label>
                    <select id="lang1" class="form-select">
                        <option value="" disabled selected>-- Select lang1 --</option>
                        <option value="EN">English (en)</option>
                        <option value="ES">Spanish (es)</option>
                        <option value="DE">German (de)</option>
                        <option value="IT">Italian (it)</option>
                    </select>
                </div>

                <div class="mb-3 mt-3">
                    <label for="lang2" class="form-label">Lang 2:</label>
                    <select id="lang2" class="form-select">
                        <option value="" disabled selected>-- Select lang2 --</option>
                        <option value="mono">N/A (Monolingual)</option>
                        <option value="en">English (en)</option>
                        <option value="es">Spanish (es)</option>
                        <option value="de">German (de)</option>
                        <option value="it">Italian (it)</option>
                    </select>
                </div>

                <div class="mb-3 mt-3">
                    <label for="kTopics">K Topics:</label>
                    <input type="number" id="kTopics" class="form-control" value="5" min="1" max="500">
                </div>

                <hr>

                <!-- Label Topic Option -->
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <label for="enableLabelTopic" class="mb-0 me-2">
                        Label Topic
                    </label>

                    <div class="form-check form-switch m-0" style="padding-right: 15px;">
                        <input type="checkbox" class="form-check-input" id="enableLabelTopic">
                        <label class="form-check-label" for="enableLabelTopic"></label>
                    </div>
                </div>

                <hr>

                <!-- LLM options (hidden by default) -->
                <div id="labelTopicOptions" class="mt-3" style="display: none;">

                    <div class="mb-3 d-flex align-items-center">
                        <label for="llmSelect_type" class="me-2 form-label" style="width: 200px;">Type of LLM:</label>
                        <select id="llmSelect_type" class="form-select flex-grow-1">
                            <option value="gemini" selected>Gemini (default)</option>
                            <option value="ollama">Ollama</option>
                            <option value="GPT">GPT</option>
                        </select>
                    </div>

                    <div id="llmSelect_gemini" class="mb-3 d-flex align-items-center">
                        <label for="llmSelect_gemini_input" class="me-2 form-label" style="width: 200px;">Gemini
                            Model:</label>
                        <select id="llmSelect_gemini_input" class="form-select flex-grow-1">
                            {% if models and models.get('gemini') %}
                            {% for model in models['gemini'] %}
                            <option value="{{ model }}" {% if model=='gemini-2.5-flash' %}selected{% endif %}>{{ model
                                }}</option>
                            {% endfor %}
                            {% else %}
                            <option value="gemini-2.5-flash" selected>gemini-2.5-flash</option>
                            {% endif %}
                        </select>
                    </div>

                    <div id="llmSelect_ollama" class="mb-3 d-flex align-items-center d-none">
                        <label for="llmSelect_ollama_input" class="me-2 form-label" style="width: 200px;">Ollama
                            LLM:</label>
                        <select id="llmSelect_ollama_input" class="form-select flex-grow-1">

                        </select>
                    </div>

                    <div id="server_ollama" class="mb-3 d-flex align-items-center d-none">
                        <label for="server_ollama_input" class="me-2 form-label" style="width: 200px;">Ollama
                            Server:</label>
                        <select id="server_ollama_input" class="form-select flex-grow-1">
                            {% for server in models.keys() %}
                            {% if server != "gemini" %}
                            <option value="{{ server }}">{{ server }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>


                    <div id="llmSelect_gpt" class="mb-3 d-flex align-items-center" style="display: none;">
                        <label for="llmSelect_gpt_input" class="me-2" style="width: 200px;">GPT LLM:</label>
                        <select id="llmSelect_gpt_input" class="form-control flex-grow-1">
                            <option value="gpt-4-turbo">gpt-4-turbo</option>
                            <option value="gpt-4" selected>gpt-4</option>
                            <option value="gpt-4o-mini">gpt-4o-mini</option>
                            <option value="gpt-4o">gpt-4o</option>
                        </select>
                    </div>

                    <div id="gptApiKey" class="mb-3 d-flex align-items-center" style="display: none;">
                        <label for="llmSelect_gpt" class="me-2" style="width: 200px;">GPT API Key:</label>
                        <input id="gptApiKeyInput" class="form-control flex-grow-1" value="" type="password"
                            autocomplete="new-password" placeholder="sk-*******-*******-******"></input>
                    </div>
                </div>

            </div>

            <!-- Step 3: Download -->
            <div class="modal-body" id="modal-body-3">

                <div class="details-toggle" data-target="#details3-Download">
                    <span>Details</span>
                    <i class="arrow"></i>
                </div>

                <div class="collapse mt-2" id="details3-Download">
                    <div class="card card-body" id="details3-Download-text">
                        Select an unprocessed or preprocessed dataset to download, or select a topic model.
                    </div>
                </div>

                <hr>

                <label for="stage-download">Stage:</label>
                <select id="stage-download" class="form-control">
                    <option value="" disabled selected>-- Select Stage --</option>
                    <option value="1">Raw Data</option>
                    <option value="2">Preprocessed Data</option>
                    <option value="3">Topic Model</option>
                </select>

                <br>

                <label id="optionsDatasets3" for="optionsDatasets3" style="display: none;">Select an option: </label>

                <select id="optionsDatasets3-1" class="form-control" style="display: none;">
                    {% if datasets %}
                    <option value="" disabled selected>-- Choose an avaible dataset --</option>
                    {% for ds, name, stage in zip(datasets, names, stages) %}
                    {% if stage == 1 or stage == '1' %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <option value="" disabled>No datasets available.</option>
                    {% endif %}
                </select>

                <select id="optionsDatasets3-2" class="form-control" style="display: none;">
                    {% if datasets %}
                    <option value="" disabled selected>-- Choose an avaible dataset --</option>
                    {% for ds, name, stage in zip(datasets, names, stages) %}
                    {% if stage == 2 or stage == '2' %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <option value="" disabled>No datasets available.</option>
                    {% endif %}
                </select>

                <label id="optionsFormatFile3" for="formatFile3" style="display: none;">Select an extension: </label>
                <select id="formatFile3" class="form-control" style="display: none;">
                    <option value="" disabled selected>-- Choose an extension --</option>

                    <option value="xlsx">Excel</option>
                    <option value="parquet">Parquet</option>
                </select>

                <select id="optionsDatasets3-3" class="form-control" style="display: none;">
                    {% if datasets %}
                    <option value="" disabled selected>-- Choose an avaible model output --</option>
                    {% for ds, name, stage in zip(datasets, names, stages) %}
                    {% if stage == 3 or stage == '3' %}
                    <option value="{{ name }}">{{ name }}</option>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <option value="" disabled>No model output available.</option>
                    {% endif %}
                </select>

                <hr>

                <div class="mb-3 mt-3">
                    <label for="outputPath">Output Path:</label>
                    <input type="text" id="outputPath3" class="form-control"
                        placeholder="Enter new name for the dataset to download">
                </div>
            </div>

            <div class="modal-footer" id="modal-footer-base">
                <!-- Close -->
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                <!-- Slide Navigation -->
                <button type="button" class="btn btn-outline-primary" id="prevSlide">Previous</button>
                <button type="button" class="btn btn-outline-primary" id="nextSlide">Next</button>

                <!-- Button Preprocess Dataset -->
                <button class="btn btn-primary" id="confirmDatasetPreprocess" style="display: none;">Accept Dataset to
                    Preprocess</button>

                <!-- Button Topic Modelling -->
                <button id="confirmTopicModelling" class="btn btn-primary">Confirm Topic Modeling</button>

                <!-- Button Download -->
                <button id="confirmDownload" class="btn btn-primary">Download Dataset/TM</button>
            </div>

        </div>
    </div>
</div>


<!-- jQuery and Bootstrap JS loaded centrally from base.html -->








<!-- Data Bridge: server-side data for preprocessing.js -->
<script>
    window.__PREPROCESSING_DATA = {
    {% if models %} availableModels: { { models | tojson } }, {% endif %}
  };
</script>

<!-- Preprocessing Page JS -->
<script src="{{ url_for('static', filename='js/preprocessing.js') }}"></script>


{% endblock %}